<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <script src="https://cdn.jsdelivr.net/npm/vue@2.6.10/dist/vue.js"></script>
        <script>
            document.addEventListener("DOMContentLoaded", () => {
                new Vue({
                    el: '#app',
                    data: {
                        word: '',
                        input: '',
                        output: '',
                        direction: 'Right',
                        next: 0,
                        instructions: [],
                        states: [],
                        selectedStateIndex: -1,
                        subscription: null,
                        infoIsActive: false,
                        selectedTab: 0,
                        raw: ''
                    },
                    methods: {
                        addInstruction: function() {
                            this.instructions.push({
                                precondition: this.input,
                                postcondition: this.output,
                                direction: this.direction,
                                successor: this.next
                            });
                        },
                        addState: function() {
                            this.states.push({
                                instructions: this.instructions
                            });
                            this.instructions = [];
                            this.raw = JSON.stringify(this.states, undefined, 2);
                        },
                        run: function() {
                            const turingMachine = window['turingMachine'];

                            if (this.subscription != null) {
                                this.subscription.unsubscribe();
                            }

                            this.subscription = turingMachine.observeState()
                                .subscribe(event => {
                                    if (event.type === 2) {
                                        this.selectedStateIndex = this.states.indexOf(event.payload.state);
                                    }
                                });

                            turingMachine.reset();
                            turingMachine.loadWord(this.word);
                            turingMachine.loadProgram(this.states);
                            turingMachine.run();
                            this.selectedStateIndex = 0;
                        },
                        clear: function() {
                            this.states = [];
                            this.instructions = [];
                        },
                        removeState: function(index) {
                            this.states.splice(index, 1);
                        },
                        removeInstruction: function(index) {
                            this.instructions.splice(index, 1);
                        },
                        toggleInfo: function() {
                            this.infoIsActive = !this.infoIsActive;
                        },
                        selectTab: function(index) {
                            this.selectedTab = index;
                        },
                        rawChanged: function() {
                            this.states = JSON.parse(this.raw);
                        }
                    }
                });
            });
        </script>

        <script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>

        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.5/css/bulma.min.css">
        <title>Turing Machine</title>
        <style>
            .symbol-input {
                width: 50px;
            }

            .clickable {
                cursor: pointer;
            }
        </style>
    </head>
    <body>
        <div class="tile is-ancestor is-vertical">
            <div class="tile is-parent">
                <div class="tile is-parent">
                    <div id="app" class="tile is-child box">
                        <div class="modal" v-bind:class="{ 'is-active': infoIsActive }">
                            <div class="modal-background"></div>
                            <div class="modal-content">
                                <div class="content box">
                                    <ul>
                                        <li>
                                            You can define states that describe the program.
                                        </li>
                                        <li>
                                            A state consists of a Instructions.
                                        </li>
                                        <li>
                                            In each state the current letter is read from the tape and the instruction to be executed is identified. The output is written back to the tape, the cursor is moved in the direction and the next state is executed.
                                        </li>
                                        <li>
                                            Empty fields on the tape  are represented with an '_'.
                                        </li>
                                        <li>
                                            The program is finished when the final state is reached.
                                        </li>
                                        <li>
                                            A state with no instructions is the final state.
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            <button class="modal-close is-large" aria-label="close" @click="toggleInfo"></button>
                        </div>
                        <div class="field">
                            <span class="icon clickable" @click="toggleInfo">
                                <i class="fas fa-info-circle"></i>
                            </span>
                        </div>
                        <div class="field is-grouped">
                            <div class="control">
                                <a id="run-button" class="button is-link" @click="run">Run</a>
                            </div>
                            <div class="control">
                                <a id="clear-button" class="button" @click="clear">Clear</a>
                            </div>
                        </div>
                        <div class="field">
                            <label for="word" class="label">Word</label>
                            <div class="control">
                                <input id="word" type="text" name="word" required="required" class="input is-small" v-model="word" />
                            </div>
                        </div>
                        <div class="tabs">
                            <ul>
                                <li v-bind:class="{ 'is-active': selectedTab === 0 }"><a @click="selectTab(0)">Visual</a></li>
                                <li v-bind:class="{ 'is-active': selectedTab === 1 }"><a @click="selectTab(1)">Raw</a></li>
                            </ul>
                        </div>
                        <div v-if="selectedTab === 0">
                            <div class="box">
                                if input equals <input id="input-new" type="text" name="input-new" required="required" class="input is-small symbol-input" v-model="input" /><br />
                                then output should be <input id="output-new" type="text" name="output-new" required="required" class="input is-small symbol-input" v-model="output" /><br />
                                the tape should move to the
                                <div class="select is-small">
                                    <select id="direction-new" v-model="direction">
                                        <option>Left</option>
                                        <option>Right</option>
                                    </select>
                                </div>
                                <br />
                                and the next state should be <input id="next-state-new" type="text" name="next-state-new" required="required" class="input is-small symbol-input" v-model="next" />
                                <div class="field is-grouped">
                                    <div class="control">
                                        <button id="instruction-button" class="button is-text" @click="addInstruction">Add instruction</button>
                                    </div>
                                    <div class="control">
                                        <button id="state-button" class="button is-text" @click="addState">Add state</button>
                                    </div>
                                </div>
                            </div>
                            <div class="box">
                                <h5 class="title is-5">Instructions for new state</h5>
                                <div v-for="(instruction, index) in instructions">
                                    if input equals {{ instruction.precondition }} then return {{ instruction.postcondition }} and move {{ instruction.direction }}; Next state is {{ instruction.successor }} <a class="delete" @click="removeInstruction(index)"></a>
                                </div>
                            </div>
                            <div class="box">
                                <h4 class="title is-4">States</h4>
                                <table class="table is-striped is-fullwidth" v-if="states.length > 0">
                                    <tr>
                                        <th>Index</th>
                                        <th>Instructions</th>
                                        <th></th>
                                    </tr>
                                    <tr v-for="(state, index) in states" v-bind:class="{ 'is-selected': index === selectedStateIndex }">
                                        <td>{{ index }}</td>
                                        <td>
                                            <div v-for="instruction in state.instructions">
                                                if input equals <b>{{ instruction.precondition }}</b> then return <b>{{ instruction.postcondition }}</b> and move <b>{{ instruction.direction }}</b>;<br />
                                                Next state is <b>{{ instruction.successor }}</b>
                                            </div>
                                        </td>
                                        <td>
                                            <a class="delete" @click="removeState(index)"></a>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                        <div v-if="selectedTab === 1">
                            <textarea rows="25" cols="75" @blur="rawChanged" v-model="raw" class="box">
                            </textarea>
                        </div>
                    </div>
                </div>
                <div class="tile is-parent">
                    <div class="tile is-child box">
                        <div id="canvas" class="tile is-child box table-container"></div>
                    </div>
                </div>
            </div>
        </div>
    <script type="text/javascript" src="bundle.js"></script></body>
</html>
