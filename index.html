<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <script src="https://cdn.jsdelivr.net/npm/vue@2.6.10/dist/vue.js"></script>
        <script>
            document.addEventListener("DOMContentLoaded", () => {
                new Vue({
                    el: '#app',
                    data: {
                        word: '',
                        input: '',
                        output: '',
                        direction: 'Right',
                        next: 0,
                        instructions: [],
                        states: [],
                        selectedStateIndex: -1,
                        subscription: null
                    },
                    methods: {
                        addInstruction: function() {
                            this.instructions.push({
                                precondition: this.input,
                                postcondition: this.output,
                                direction: this.direction,
                                successor: this.next
                            });
                        },
                        addState: function() {
                            this.states.push({
                                instructions: this.instructions
                            });
                            this.instructions = [];
                        },
                        run: function() {
                            const turingMachine = window['turingMachine'];

                            if (this.subscription != null) {
                                this.subscription.unsubscribe();
                            }

                            this.subscription = turingMachine.observeState()
                                .subscribe((data) => this.selectedStateIndex = this.states.indexOf(data[1]));

                            turingMachine.reset();
                            turingMachine.loadWord(this.word);
                            turingMachine.loadProgram(this.states);
                            turingMachine.run();
                        },
                        clear: function() {
                            this.states = [];
                            this.instructions = [];
                        },
                        removeState: function(index) {
                            this.states.splice(index, 1);
                        },
                        removeInstruction: function(index) {
                            this.instructions.splice(index, 1);
                        }
                    }
                });
            });
        </script>

        <script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>

        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.5/css/bulma.min.css">
        <title>Turing Machine</title>
        <style>
            .symbol-input {
                width: 50px;
            }
        </style>
    </head>
    <body>
        <div class="tile is-ancestor is-vertical">
            <div class="tile is-parent">
                <div class="tile is-parent">
                    <div id="app" class="tile is-child box">
                        <div class="field is-grouped">
                            <div class="control">
                                <a id="run-button" class="button is-link" @click="run">Run</a>
                            </div>
                            <div class="control">
                                <a id="clear-button" class="button" @click="clear">Clear</a>
                            </div>
                        </div>
                        <div class="field">
                            <label for="word" class="label">Word</label>
                            <div class="control">
                                <input id="word" type="text" name="word" required="required" class="input is-small" v-model="word" />
                            </div>
                        </div>
                        <div class="box">
                            if input equals <input id="input-new" type="text" name="input-new" required="required" class="input is-small symbol-input" v-model="input" />
                            then output should be <input id="output-new" type="text" name="output-new" required="required" class="input is-small symbol-input" v-model="output" />
                            the tape should move to the
                            <div class="select is-small">
                                <select id="direction-new" v-model="direction">
                                    <option>Left</option>
                                    <option>Right</option>
                                </select>
                            </div>
                            and the next state should be <input id="next-state-new" type="text" name="next-state-new" required="required" class="input is-small symbol-input" v-model="next" />
                            <div class="field is-grouped">
                                <div class="control">
                                    <a id="instruction-button" class="button is-text" @click="addInstruction">Add instruction</a>
                                </div>
                                <div class="control">
                                    <button id="state-button" class="button is-text" @click="addState">Add state</a>
                                </div>
                            </div>
                        </div>
                        <div class="box">
                            <h5 class="title is-5">Instructions for new state</h5>
                            <div v-for="(instruction, index) in instructions">
                                if input equals {{ instruction.precondition }} then return {{ instruction.postcondition }} and move {{ instruction.direction }}; Next state is {{ instruction.successor }} <a class="delete" @click="removeInstruction(index)"></a>
                            </div>
                        </div>
                        <div class="box">
                            <h4 class="title is-4">States</h4>
                            <table class="table is-striped">
                                <tr>
                                    <th>Index</th>
                                    <th>Instructions</th>
                                    <th></th>
                                </tr>
                                <tr v-for="(state, index) in states" v-bind:class="{ 'is-selected': index === selectedStateIndex }">
                                    <td>{{ index }}</td>
                                    <td>
                                        <div v-for="instruction in state.instructions">
                                            if input equals {{ instruction.precondition }} then return {{ instruction.postcondition }} and move {{ instruction.direction }}; Next state is {{ instruction.successor }}
                                        </div>
                                    </td>
                                    <td>
                                        <a class="delete" @click="removeState(index)"></a>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    <div class="tile is-parent">
                        <div class="tile is-child box">
                            <div id="canvas" class="tile is-child box" />
                        </div>
                    </div>
                </div>
            </div>
        </div>
    <script type="text/javascript" src="bundle.js"></script></body>
</html>
